<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedDash Admin Panel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            min-height: 100vh;
        }

        /* animated, colorful background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 25%, #ec4899 50%, #06b6d4 75%, #1e3a8a 100%);
            background-size: 400% 400%;
            animation: gradientShift 14s ease infinite;
            z-index: -2;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(59,130,246,0.06) 0%, transparent 40%),
                        radial-gradient(circle at 80% 80%, rgba(231,76,60,0.04) 0%, transparent 40%);
            z-index: -1;
            pointer-events: none;
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(8px);
            border-radius: 20px;
            padding: 36px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.14);
            width: 100%;
            max-width: 420px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }

        .login-card:hover { transform: translateY(-6px); box-shadow: 0 35px 70px rgba(0,0,0,0.2); }

        .login-header {
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .login-form {
            margin-bottom: 20px;
        }

        .login-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 15px;
            transition: border-color 0.3s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: #e74c3c;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .login-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .login-links {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .login-link {
            color: #e74c3c;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        .login-link:hover {
            color: #c0392b;
            text-decoration: underline;
        }

        .register-prompt {
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
            color: #6c757d;
        }

        .register-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            margin-top: 10px;
        }

        .register-btn:hover {
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .forgot-password-form, .create-account-form {
            display: none;
        }

        .back-btn {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            margin-bottom: 15px;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, rgba(15,23,42,0.96) 0%, rgba(231,76,60,0.12) 100%);
            backdrop-filter: blur(12px);
            color: white;
            padding: 20px 16px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            border-right: 1px solid rgba(231,76,60,0.12);
            box-shadow: 6px 0 30px rgba(0,0,0,0.18);
        }

        .sidebar-header {
            text-align: center;
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .admin-info {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }

        .admin-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-size: 1.5rem;
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-item {
            display: block;
            padding: 15px 25px;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 1rem;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            padding-left: 35px;
        }

        .nav-item.active {
            background: rgba(255,255,255,0.2);
            border-right: 4px solid white;
        }

        .nav-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-item.disabled:hover {
            background: none;
            padding-left: 25px;
        }

        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 20px;
        }

        .content-section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f2f6;
        }

        .section-header h2 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .section-header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card.success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .stat-card.info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .stat-card h3 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 500;
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: #e74c3c;
        }

        .input-group input[readonly] {
            background: #f8f9fa;
            color: #6c757d;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .users-table th, .users-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .users-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            font-weight: 600;
        }

        .users-table tr:hover {
            background: #f8f9fa;
        }

        .user-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .ct-scan-upload {
            border: 2px dashed #e9ecef;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .ct-scan-upload:hover {
            border-color: #e74c3c;
            background: #fdf2f2;
        }

        .ct-scan-upload.dragover {
            border-color: #e74c3c;
            background: #fdf2f2;
        }

        .scan-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .scan-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .scan-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #e74c3c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tab-btn {
            padding: 15px 25px;
            border: none;
            background: #f8f9fa;
            color: #6c757d;
            cursor: pointer;
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .analysis-result {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .prediction-card {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            text-align: center;
        }

        .prediction-card.abnormal {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }

        .prediction-card.critical {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        }

        .recommendation-card {
            background: #f8f9fa;
            border-left: 4px solid #e74c3c;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .patient-info-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .patient-images {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .patient-images img {
            width: 100px;
            height: 100px;
            border-radius: 10px;
            object-fit: cover;
            border: 3px solid rgba(59,130,246,0.9);
            transition: transform 0.18s ease, box-shadow 0.18s ease;
        }

        @media (max-width: 480px) {
            .patient-images img {
                width: 80px;
                height: 80px;
            }
        }

        .scan-history-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #e74c3c;
        }

        .download-section {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin-top: 20px;
        }

        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .login-logs {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-top: 20px;
        }

        .log-entry {
            padding: 15px;
            border-bottom: 1px solid #f1f2f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry:hover {
            background: #f8f9fa;
        }

        .log-user {
            font-weight: 500;
            color: #2c3e50;
        }

        .log-time {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .log-status {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .log-success {
            background: #d4edda;
            color: #155724;
        }

        .log-failed {
            background: #f8d7da;
            color: #721c24;
        }
        .section-header{
            align-items: center;
            display:grid;
            justify-content: center;
            place-items: center;
        }
        .section-header img{
            gap:10px;
            line-height: normal;
            width:400px;
            align-items: center;
            display:block;
            justify-content: center;
            border-radius: 10%;
            border-color: rgb(59, 119, 124);
            margin:20px 20px;
            border:2px solid blanchedalmond;
        }
        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 60px 15px 15px;
            }

            .mobile-menu-btn {
                display: block;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .login-card {
                margin: 10px;
                padding: 20px;
                max-width: 90%;
            }

            .users-table {
                font-size: 0.8rem;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            .users-table th, .users-table td {
                padding: 8px 5px;
                min-width: 100px;
            }

            .section-header h2 {
                font-size: 1.5rem;
            }

            .stat-card h3 {
                font-size: 2rem;
            }
        }

        /* Desktop view - ensure proper display */
        @media (min-width: 769px) {
            .sidebar {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 280px;
                padding: 20px;
            }

            .mobile-menu-btn {
                display: none !important;
            }
        }
    </style>
<script src="server-integration.js"></script>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>üîê Admin Panel</h1>
                <p>MedDash Administration</p>
            </div>
            
            <!-- Login Form -->
            <form id="loginForm" class="login-form">
                <input type="email" id="loginEmail" class="login-input" placeholder="Admin Email" required>
                <input type="password" id="loginPassword" class="login-input" placeholder="Admin Password" required>
                <button type="submit" class="login-btn" id="loginBtn">üö™ Admin Login</button>
                
                <div class="login-links">
                    <a href="#" class="login-link" onclick="showForgotPassword()">Forgot Password?</a>
                </div>
            </form>
            
            <!-- Forgot Password Form -->
            <form id="forgotPasswordForm" class="forgot-password-form">
                <input type="email" id="forgotEmail" class="login-input" placeholder="Enter admin email" required>
                <button type="submit" class="login-btn">üìß Send Reset Link</button>
                <button type="button" class="login-btn back-btn" onclick="showLoginForm()">‚Üê Back to Login</button>
            </form>
            
            <!-- Register Prompt -->
            <div class="register-prompt">
                <p>Need admin access?</p>
                <button type="button" class="login-btn register-btn" onclick="showCreateAccountForm()">üë®‚Äçüíº Register Admin</button>
            </div>
            
            <!-- Create Admin Account Form -->
            <form id="createAccountForm" class="create-account-form" style="display: none;">
                <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">Create Admin Account</h3>
                <input type="text" id="createFullName" class="login-input" placeholder="Full Name" required>
                <input type="email" id="createEmail" class="login-input" placeholder="Admin Email" required>
                <input type="password" id="createPassword" class="login-input" placeholder="Password (min 6 characters)" required minlength="6">
                <input type="password" id="confirmPassword" class="login-input" placeholder="Confirm Password" required>
                <input type="text" id="adminCode" class="login-input" placeholder="Admin Access Code" required>
                <small style="color: #6c757d; display: block; margin-bottom: 15px;">Contact system administrator for access code</small>
                <button type="submit" class="login-btn">üéâ Create Admin Account</button>
                <button type="button" class="login-btn back-btn" onclick="showLoginForm()">‚Üê Back to Login</button>
            </form>
            
            <div id="loginMessage"></div>
        </div>
    </div>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()" style="display: none;">‚ò∞</button>

    <!-- Dashboard -->
    <div class="dashboard-container" id="dashboardContainer" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>üîê Admin Panel</h2>
                <p>MedDash Administration</p>
            </div>
            
            <div class="admin-info">
                <div class="admin-avatar">üë®‚Äçüíº</div>
                <div id="currentAdmin">Admin User</div>
                <div style="font-size: 0.8rem; opacity: 0.8;">Administrator</div>
            </div>
            
            <nav class="nav-menu">
                <button class="nav-item active" onclick="showSection('dashboard')">
                    üìä Dashboard
                </button>
                <button class="nav-item" onclick="showSection('adminRegistration')">
                    üìã Admin Registration
                </button>
                <button class="nav-item disabled" id="adminProfileNav" onclick="showSection('adminProfile')">
                    üë§ Admin Profile
                </button>
                <button class="nav-item" onclick="showSection('userManagement')">
                    üë• User Management
                </button>
                <button class="nav-item" onclick="showSection('ctScanUpload')">
                    üè• CT Scan Upload
                </button>
                <button class="nav-item" onclick="showSection('loginLogs')">
                    üìù Login Logs
                </button>
                <button class="nav-item" onclick="logout()">
                    üö™ Logout
                </button>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <div class="section-header">
                    <h2>Admin Dashboard</h2>
                    <p>System overview and statistics</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="totalUsers">0</h3>
                        <p>Total Users</p>
                    </div>
                    <div class="stat-card success">
                        <h3 id="registeredUsers">0</h3>
                        <p>Registered Users</p>
                    </div>
                    <div class="stat-card warning">
                        <h3 id="totalAdmins">0</h3>
                        <p>Total Admins</p>
                    </div>
                    <!-- CT scan stat removed from dashboard home view -->
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">üìà Recent Activity</h3>
                        <div id="recentActivity">
                            <p style="color: #6c757d;">Loading recent activity...</p>
                        </div>
                    </div>
                    
                    <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">üîß Quick Actions</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn btn-primary" onclick="showSection('userManagement')">View All Users</button>
                            <button class="btn btn-info" onclick="showSection('loginLogs')">View Login Logs</button>
                        </div>
                    </div>
                </div>

                <div style="background: #e8f5e8; border-radius: 15px; padding: 25px; text-align: center;">
                    <h3 style="color: #155724; margin-bottom: 15px;">üéØ Admin Panel Features</h3>
                    <p style="color: #155724; margin-bottom: 20px;">Manage users, track system activity, and maintain platform security.</p>
                </div>
            </div>

            <!-- Admin Registration Section -->
            <div id="adminRegistration" class="content-section">
                <div class="section-header">
                    <h2>Admin Registration</h2>
                    <p>Complete admin profile registration</p>
                </div>
                
                <form id="adminRegistrationForm">
                    <div class="form-grid">
                        <div>
                            <div class="input-group">
                                <label for="adminUniqueId">Admin ID</label>
                                <input type="text" id="adminUniqueId" readonly>
                            </div>
                            <div class="input-group">
                                <label for="adminRegDate">Registration Date</label>
                                <input type="date" id="adminRegDate" readonly>
                            </div>
                            <div class="input-group">
                                <label for="adminRegTime">Registration Time</label>
                                <input type="time" id="adminRegTime" readonly>
                            </div>
                            <div class="input-group">
                                <label for="adminFullName">Full Name *</label>
                                <input type="text" id="adminFullName" required placeholder="Enter full name">
                            </div>
                            <div class="input-group">
                                <label for="adminAge">Age *</label>
                                <input type="number" id="adminAge" required min="18" max="80" placeholder="Enter age">
                            </div>
                            <div class="input-group">
                                <label for="adminGender">Gender *</label>
                                <select id="adminGender" required>
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <div class="input-group">
                                <label for="adminDepartment">Department *</label>
                                <select id="adminDepartment" required>
                                    <option value="">Select Department</option>
                                    <option value="Radiology">Radiology</option>
                                    <option value="Oncology">Oncology</option>
                                    <option value="Pulmonology">Pulmonology</option>
                                    <option value="General Medicine">General Medicine</option>
                                    <option value="IT Administration">IT Administration</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="adminPosition">Position *</label>
                                <input type="text" id="adminPosition" required placeholder="e.g., Senior Radiologist">
                            </div>
                            <div class="input-group">
                                <label for="adminContact">Contact Number *</label>
                                <input type="tel" id="adminContact" required pattern="[0-9]{10}" placeholder="Enter contact number">
                            </div>
                            <div class="input-group">
                                <label for="adminEmail">Email Address *</label>
                                <input type="email" id="adminEmail" required placeholder="Enter email address">
                            </div>
                            <div class="input-group">
                                <label for="adminLicense">Medical License (if applicable)</label>
                                <input type="text" id="adminLicense" placeholder="Enter license number">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="input-group">
                            <label for="adminPhoto">Profile Photo (Optional)</label>
                            <input type="file" id="adminPhoto" accept="image/*">
                            <small style="color: #6c757d;">Upload a professional photo (optional - default avatar will be used if not provided)</small>
                        </div>
                        <div class="input-group">
                            <label for="adminAddress">Work Address</label>
                            <textarea id="adminAddress" rows="4" placeholder="Enter work address"></textarea>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="adminRegisterBtn">
                        üìù Complete Admin Registration
                    </button>
                </form>
                
                <div id="adminRegistrationMessage"></div>
                <div id="adminRegistrationResults"></div>
            </div>

            <!-- Admin Profile Section -->
            <div id="adminProfile" class="content-section">
                <div class="section-header">
                    <h2>Admin Profile</h2>
                    <p>View and manage admin profile information</p>
                </div>
                
                <!-- Profile Display -->
                <div id="adminProfileDisplay" style="display: none;">
                    <div style="background: linear-gradient(135deg, #2c3e50 0%, #e74c3c 100%); border-radius: 20px; padding: 40px; text-align: center; color: white; margin-bottom: 30px;">
                        <div id="adminProfilePhotoDisplay" style="width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 20px; border: 4px solid white; overflow: hidden; background: rgba(255,255,255,0.2);">
                            <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 3rem;">üë®‚Äçüíº</div>
                        </div>
                        <h2 id="adminProfileDisplayName" style="margin-bottom: 10px; font-size: 2rem;">Admin Name</h2>
                        <p id="adminProfileDisplayId" style="opacity: 0.9; font-size: 1.1rem;">Admin ID</p>
                        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px; flex-wrap: wrap;">
                            <div style="background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 25px;">
                                <span id="adminProfileDisplayDept">Department</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 25px;">
                                <span id="adminProfileDisplayPos">Position</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                            <h3 style="color: #2c3e50; margin-bottom: 20px;">üìß Contact Information</h3>
                            <p style="margin-bottom: 10px;"><strong>Email:</strong> <span id="adminProfileDisplayEmail">email@example.com</span></p>
                            <p style="margin-bottom: 10px;"><strong>Phone:</strong> <span id="adminProfileDisplayPhone">+1234567890</span></p>
                            <p style="margin-bottom: 10px;"><strong>License:</strong> <span id="adminProfileDisplayLicense">Not provided</span></p>
                        </div>
                        
                        <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                            <h3 style="color: #2c3e50; margin-bottom: 20px;">üè¢ Work Information</h3>
                            <p style="margin-bottom: 10px;"><strong>Department:</strong> <span id="adminProfileDisplayDepartment">Department</span></p>
                            <p style="margin-bottom: 10px;"><strong>Position:</strong> <span id="adminProfileDisplayPosition">Position</span></p>
                            <p><strong>Address:</strong> <span id="adminProfileDisplayAddress">Address not provided</span></p>
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button class="btn btn-primary" onclick="showEditAdminProfile()">‚úèÔ∏è Edit Profile</button>
                    </div>
                </div>
                
                <!-- Profile Edit Form -->
                <div id="adminProfileEditForm" style="display: none;">
                    <form id="adminProfileUpdateForm">
                        <div class="form-grid">
                            <div>
                                <div class="input-group">
                                    <label for="editAdminFullName">Full Name</label>
                                    <input type="text" id="editAdminFullName" required>
                                </div>
                                <div class="input-group">
                                    <label for="editAdminAge">Age</label>
                                    <input type="number" id="editAdminAge" min="18" max="80" required>
                                </div>
                                <div class="input-group">
                                    <label for="editAdminGender">Gender</label>
                                    <select id="editAdminGender" required>
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="editAdminDepartment">Department</label>
                                    <select id="editAdminDepartment" required>
                                        <option value="">Select Department</option>
                                        <option value="Radiology">Radiology</option>
                                        <option value="Oncology">Oncology</option>
                                        <option value="Pulmonology">Pulmonology</option>
                                        <option value="General Medicine">General Medicine</option>
                                        <option value="IT Administration">IT Administration</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <div class="input-group">
                                    <label for="editAdminPosition">Position</label>
                                    <input type="text" id="editAdminPosition" required>
                                </div>
                                <div class="input-group">
                                    <label for="editAdminContact">Contact Number</label>
                                    <input type="tel" id="editAdminContact" required>
                                </div>
                                <div class="input-group">
                                    <label for="editAdminLicense">Medical License</label>
                                    <input type="text" id="editAdminLicense">
                                </div>
                                <div class="input-group">
                                    <label for="editAdminAddress">Work Address</label>
                                    <textarea id="editAdminAddress" rows="4"></textarea>
                                </div>
                                <div class="input-group">
                                    <label for="editAdminPhoto">Update Profile Photo</label>
                                    <input type="file" id="editAdminPhoto" accept="image/*">
                                    <small style="color: #6c757d;">Leave empty to keep current photo</small>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button type="submit" class="btn btn-success" style="margin-right: 15px;">üíæ Update Profile</button>
                            <button type="button" class="btn" onclick="cancelEditAdminProfile()" style="background: #6c757d; color: white;">‚ùå Cancel</button>
                        </div>
                    </form>
                </div>
                
                <!-- Not Registered Message -->
                <div id="adminProfileNotRegistered">
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 15px; padding: 30px; text-align: center;">
                        <h3 style="color: #856404; margin-bottom: 15px;">üìã Complete Admin Registration Required</h3>
                        <p style="color: #856404; margin-bottom: 20px;">Complete admin registration to access profile management.</p>
                        <button class="btn btn-primary" onclick="showSection('adminRegistration')">Complete Registration</button>
                    </div>
                </div>
            </div>

            <!-- User Management Section -->
            <div id="userManagement" class="content-section">
                <div class="section-header">
                    <h2>User Management</h2>
                    <p>View and manage registered users</p>
                </div>
                
                <div style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="btn btn-info" onclick="refreshUserData()">üîÑ Refresh Data</button>
                    <button class="btn btn-success" onclick="exportUserData()">üìä Export Data</button>
                    <button class="btn btn-warning" id="toggleUserDataBtn" onclick="toggleUserDataVisibility()">üëÅÔ∏è Show User Data</button>
                    <input type="text" id="userSearchInput" placeholder="Search users..." style="padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; flex: 1; min-width: 200px;" onkeyup="filterUsers()">
                </div>
                
                <div id="usersTableContainer">
                    <table class="users-table" id="usersTable">
                        <thead>
                            <tr>
                                <th>Photo</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Age</th>
                                <th>Gender</th>
                                <th>City</th>
                                <th>Contact</th>
                                <th>Registration Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 40px; color: #6c757d;">
                                    Loading user data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CT Scan Upload Section -->
            <div id="ctScanUpload" class="content-section">
                <div class="section-header">
                    <h2>CT Scan Analysis System</h2>
                    <p>Upload CT scans for AI-powered analysis and generate professional reports</p>
                    <img src="C:\Users\User\OneDrive\Desktop\P-Phase 2\lung-Dashboard\CT-Lung-Cancer-Photo.jpg" alt="CT Scan illustration" style="max-width:100%; border-radius:8px;">
                    <div style="text-align:center; margin-top:14px;">
                        <a href=" http://localhost:9002" target="_blank" rel="noopener noreferrer" class="btn btn-primary" aria-label="Open CT Scan Upload portal in a new tab" title="Open CT Scan Upload">
                            üì§ Upload CT Scan & Generate Report
                        </a>
                        <div style="margin-top:8px; color:#6c757d; font-size:0.95rem;">Opens secure upload portal in a new tab. Ensure patient consent before uploading.</div>
                    </div>
                </div>
            </div>
            <!-- Login Logs Section -->
            <div id="loginLogs" class="content-section">
                <div class="section-header">
                    <h2>Login Logs</h2>
                    <p>Track user and admin login activities</p>
                </div>
                <div style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="btn btn-info" onclick="refreshLoginLogs()">üîÑ Refresh Logs</button>
                </div>
                <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 320px;">
                        <h3 style="color: #2c3e50; margin-bottom: 10px;">üë§ User Login Logs</h3>
                        <div class="login-logs" id="userLoginLogsContainer">
                            <div style="text-align: center; padding: 40px; color: #6c757d;">Loading user login logs...</div>
                        </div>
                    </div>
                    <div style="flex: 1; min-width: 320px;">
                        <h3 style="color: #2c3e50; margin-bottom: 10px;">üë®‚Äçüíº Admin Login Logs</h3>
                        <div class="login-logs" id="adminLoginLogsContainer">
                            <div style="text-align: center; padding: 40px; color: #6c757d;">Loading admin login logs...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentAdminData = null;
        let currentAdminName = '';
        let isAdminLoggedIn = false;
        let adminRegistered = false;
        let uploadedScans = [];
        let showUserData = false;

        // Initialize system
        function initializeSystem() {
            checkAdminLoginStatus();
            if (isAdminLoggedIn) {
                showDashboard();
                generateAdminUniqueId();
                updateAdminStats();
                checkAdminRegistration();
                updateAdminDisplay();
                loadUserData();
                loadPatientOptions();
                loadLoginLogs();
                showSection('dashboard');
            } else {
                showLoginPage();
            }
        }

        // Check admin login status
        function checkAdminLoginStatus() {
            const sessionData = localStorage.getItem('adminSession');
            if (sessionData) {
                const session = JSON.parse(sessionData);
                if (session.email) {
                    const adminAccounts = JSON.parse(localStorage.getItem('adminAccounts') || '[]');
                    const admin = adminAccounts.find(a => a.email === session.email);
                    
                    if (admin) {
                        currentAdminData = admin;
                        currentAdminName = admin.fullName || admin.email;
                        isAdminLoggedIn = true;
                        
                        const adminRegistrations = JSON.parse(localStorage.getItem('adminRegistrations') || '[]');
                        const registration = adminRegistrations.find(r => r.email === admin.email);
                        adminRegistered = !!registration;
                    }
                }
            }
        }

        // Show login page
        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboardContainer').style.display = 'none';
            document.querySelector('.mobile-menu-btn').style.display = 'none';
        }

        // Show dashboard
        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboardContainer').style.display = 'flex';
            document.querySelector('.mobile-menu-btn').style.display = 'block';
        }

        // Login form functions
        function showForgotPassword() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'block';
        }

        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('forgotPasswordForm').style.display = 'none';
            document.getElementById('createAccountForm').style.display = 'none';
        }

        function showCreateAccountForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'none';
            document.getElementById('createAccountForm').style.display = 'block';
        }

        // Login form handling
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const messageDiv = document.getElementById('loginMessage');
            
            const adminAccounts = JSON.parse(localStorage.getItem('adminAccounts') || '[]');
            const admin = adminAccounts.find(a => a.email === email && a.password === password);
            
            if (admin) {
                // Log successful login
                logLoginAttempt(email, 'admin', true);
                
                localStorage.setItem('adminSession', JSON.stringify({
                    email: admin.email,
                    loginTime: new Date().toISOString()
                }));
                
                currentAdminData = admin;
                currentAdminName = admin.fullName || admin.email;
                isAdminLoggedIn = true;
                
                const adminRegistrations = JSON.parse(localStorage.getItem('adminRegistrations') || '[]');
                const registration = adminRegistrations.find(r => r.email === admin.email);
                adminRegistered = !!registration;
                
                messageDiv.innerHTML = '<div style="color: #27ae60; margin-top: 15px;">‚úÖ Admin login successful!</div>';
                
                setTimeout(() => {
                    showDashboard();
                    updateAdminDisplay();
                    updateAdminStats();
                    loadUserData();
                    loadPatientOptions();
                    loadLoginLogs();
                    if (adminRegistered) {
                        enableAdminProfileSection();
                    }
                    showSection('dashboard');
                }, 1500);
            } else {
                // Log failed login attempt
                logLoginAttempt(email, 'admin', false);
                messageDiv.innerHTML = '<div style="color: #e74c3c; margin-top: 15px;">‚ùå Invalid admin credentials!</div>';
            }
        });

        // Create admin account form handling
        document.getElementById('createAccountForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fullName = document.getElementById('createFullName').value;
            const email = document.getElementById('createEmail').value;
            const password = document.getElementById('createPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const adminCode = document.getElementById('adminCode').value;
            const messageDiv = document.getElementById('loginMessage');
            
            // Check admin access code (demo code: ADMIN2024)
            if (adminCode !== 'ADMIN2024') {
                messageDiv.innerHTML = '<div style="color: #e74c3c; margin-top: 15px;">‚ùå Invalid admin access code!</div>';
                return;
            }
            
            if (password !== confirmPassword) {
                messageDiv.innerHTML = '<div style="color: #e74c3c; margin-top: 15px;">‚ùå Passwords do not match!</div>';
                return;
            }
            
            const adminAccounts = JSON.parse(localStorage.getItem('adminAccounts') || '[]');
            if (adminAccounts.find(a => a.email === email)) {
                messageDiv.innerHTML = '<div style="color: #e74c3c; margin-top: 15px;">‚ùå Admin email already exists!</div>';
                return;
            }
            
            const newAdmin = {
                fullName: fullName,
                email: email,
                password: password,
                accountCreated: new Date().toISOString()
            };
            
            adminAccounts.push(newAdmin);
            localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
            
            messageDiv.innerHTML = '<div style="color: #27ae60; margin-top: 15px;">‚úÖ Admin account created successfully!</div>';
            
            document.getElementById('createAccountForm').reset();
            
            setTimeout(() => {
                showLoginForm();
                document.getElementById('loginEmail').value = email;
                messageDiv.innerHTML = '<div style="color: #3498db; margin-top: 15px;">üí° Please login with your admin credentials.</div>';
            }, 2000);
        });

        // Generate admin unique ID and set current date/time
        function generateAdminUniqueId() {
            const uniqueId = 'ADM' + Date.now().toString().slice(-6) + Math.random().toString(36).substr(2, 4).toUpperCase();
            const adminUniqueIdField = document.getElementById('adminUniqueId');
            if (adminUniqueIdField) {
                adminUniqueIdField.value = uniqueId;
            }
            
            const now = new Date();
            const currentDate = now.toISOString().split('T')[0];
            const currentTime = now.toTimeString().split(' ')[0].slice(0, 5);
            
            const adminRegDateField = document.getElementById('adminRegDate');
            const adminRegTimeField = document.getElementById('adminRegTime');
            
            if (adminRegDateField) {
                adminRegDateField.value = currentDate;
            }
            if (adminRegTimeField) {
                adminRegTimeField.value = currentTime;
            }
        }

        // Check admin registration
        function checkAdminRegistration() {
            const adminRegistrations = JSON.parse(localStorage.getItem('adminRegistrations') || '[]');
            const registration = adminRegistrations.find(r => r.email === currentAdminData.email);
            
            if (registration) {
                adminRegistered = true;
                enableAdminProfileSection();
                
                const registrationSection = document.getElementById('adminRegistration');
                if (registrationSection) {
                    registrationSection.innerHTML = `
                        <div class="section-header">
                            <h2>Admin Registration Complete</h2>
                            <p>Admin profile registration completed</p>
                        </div>
                        <div style="background: #d4edda; border-radius: 15px; padding: 25px; text-align: center;">
                            <h3 style="color: #155724; margin-bottom: 15px;">‚úÖ Admin Registration Complete</h3>
                            <p style="color: #155724; margin-bottom: 20px;">Admin profile has been successfully registered.</p>
                            <button class="btn btn-primary" onclick="showSection('adminProfile')">View Admin Profile</button>
                        </div>
                    `;
                }
            } else if (currentAdminData) {
                document.getElementById('adminFullName').value = currentAdminData.fullName || '';
                document.getElementById('adminEmail').value = currentAdminData.email || '';
            }
        }

        // Enable admin profile section
        function enableAdminProfileSection() {
            const profileNav = document.getElementById('adminProfileNav');
            profileNav.classList.remove('disabled');
            profileNav.style.opacity = '1';
            profileNav.style.cursor = 'pointer';
        }

        // Update admin display
        function updateAdminDisplay() {
            document.getElementById('currentAdmin').textContent = currentAdminName;
            
            const adminAvatar = document.querySelector('.admin-avatar');
            if (currentAdminData && currentAdminData.adminPhoto) {
                adminAvatar.innerHTML = `<img src="${currentAdminData.adminPhoto}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" alt="Admin Photo">`;
            } else {
                adminAvatar.innerHTML = 'üë®‚Äçüíº';
            }
        }

        // Admin registration form handling
        document.getElementById('adminRegistrationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const adminRegistrations = JSON.parse(localStorage.getItem('adminRegistrations') || '[]');
            const existingReg = adminRegistrations.find(r => r.email === currentAdminData.email);
            if (existingReg) {
                alert('Admin registration already completed!');
                return;
            }
            
            const registerBtn = document.getElementById('adminRegisterBtn');
            const messageDiv = document.getElementById('adminRegistrationMessage');
            
            registerBtn.disabled = true;
            registerBtn.innerHTML = '<div class="loading"></div>Processing Registration...';
            
            const formData = {
                uniqueId: document.getElementById('adminUniqueId').value,
                registrationDate: document.getElementById('adminRegDate').value,
                registrationTime: document.getElementById('adminRegTime').value,
                fullName: document.getElementById('adminFullName').value,
                age: document.getElementById('adminAge').value,
                gender: document.getElementById('adminGender').value,
                department: document.getElementById('adminDepartment').value,
                position: document.getElementById('adminPosition').value,
                contact: document.getElementById('adminContact').value,
                email: document.getElementById('adminEmail').value,
                license: document.getElementById('adminLicense').value,
                address: document.getElementById('adminAddress').value,
                registrationTimestamp: new Date().toISOString()
            };
            
            const adminPhotoFile = document.getElementById('adminPhoto').files[0];
            let adminPhotoData = null;
            
            if (adminPhotoFile) {
                const adminReader = new FileReader();
                adminReader.onerror = function() {
                    messageDiv.innerHTML = '<div class="alert alert-error">Error reading photo file!</div>';
                    registerBtn.disabled = false;
                    registerBtn.innerHTML = 'üìù Complete Admin Registration';
                };
                adminReader.onload = function(e) {
                    adminPhotoData = e.target.result;
                    processAdminRegistration(adminPhotoData);
                };
                adminReader.readAsDataURL(adminPhotoFile);
                return;
            } else {
                processAdminRegistration(null);
                return;
            }
            
            function processAdminRegistration(adminPhotoData) {
                formData.adminPhoto = adminPhotoData;
                
                setTimeout(() => {
                    adminRegistrations.push(formData);
                    localStorage.setItem('adminRegistrations', JSON.stringify(adminRegistrations));
                    
                    const adminAccounts = JSON.parse(localStorage.getItem('adminAccounts') || '[]');
                    const accountIndex = adminAccounts.findIndex(a => a.email === formData.email);
                    if (accountIndex !== -1 && formData.fullName !== adminAccounts[accountIndex].fullName) {
                        adminAccounts[accountIndex].fullName = formData.fullName;
                        localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
                        currentAdminData.fullName = formData.fullName;
                        currentAdminName = formData.fullName;
                    }
                    
                    adminRegistered = true;
                    enableAdminProfileSection();
                    updateAdminDisplay();
                    
                    messageDiv.innerHTML = '<div class="alert alert-success">‚úÖ Admin registration completed successfully!</div>';
                    
                    displayAdminRegistrationResults(formData);
                    updateAdminStats();
                    
                    setTimeout(() => {
                        checkAdminRegistration();
                    }, 3000);
                    
                }, 2000);
            }
        });

        // Display admin registration results
        function displayAdminRegistrationResults(data) {
            const resultsDiv = document.getElementById('adminRegistrationResults');
            resultsDiv.innerHTML = `
                <div class="analysis-result">
                    <h4>‚úÖ Admin Registration Successful</h4>
                    
                    <div style="text-align: center; margin: 20px 0;">
                        ${data.adminPhoto ? `<img src="${data.adminPhoto}" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #e74c3c;" alt="Admin Photo"><p style="margin-top: 10px; font-size: 0.9rem; color: #6c757d;">Admin Profile Photo</p>` : `<div style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #e74c3c, #c0392b); display: flex; align-items: center; justify-content: center; margin: 0 auto; color: white; font-weight: bold; font-size: 2.5rem;">${data.fullName.charAt(0).toUpperCase()}</div><p style="margin-top: 10px; font-size: 0.9rem; color: #6c757d;">Default Avatar (No photo uploaded)</p>`}
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <h5 style="color: #2c3e50; margin-bottom: 15px;">Admin Details</h5>
                        <p><strong>Name:</strong> ${data.fullName}</p>
                        <p><strong>Admin ID:</strong> ${data.uniqueId}</p>
                        <p><strong>Department:</strong> ${data.department}</p>
                        <p><strong>Position:</strong> ${data.position}</p>
                        <p><strong>Email:</strong> ${data.email}</p>
                        <p><strong>Contact:</strong> ${data.contact}</p>
                        <p><strong>Registration Date:</strong> ${data.registrationDate} at ${data.registrationTime}</p>
                        ${data.license ? `<p><strong>License:</strong> ${data.license}</p>` : ''}
                        ${data.address ? `<p><strong>Address:</strong> ${data.address}</p>` : ''}
                    </div>
                </div>
            `;
        }

        // Load admin profile
        function loadAdminProfile() {
            if (adminRegistered && currentAdminData) {
                const adminRegistrations = JSON.parse(localStorage.getItem('adminRegistrations') || '[]');
                const registration = adminRegistrations.find(r => r.email === currentAdminData.email);
                
                if (registration) {
                    document.getElementById('adminProfileDisplay').style.display = 'block';
                    document.getElementById('adminProfileEditForm').style.display = 'none';
                    document.getElementById('adminProfileNotRegistered').style.display = 'none';
                    
                    document.getElementById('adminProfileDisplayName').textContent = registration.fullName;
                    document.getElementById('adminProfileDisplayId').textContent = registration.uniqueId;
                    document.getElementById('adminProfileDisplayDept').textContent = registration.department;
                    document.getElementById('adminProfileDisplayPos').textContent = registration.position;
                    document.getElementById('adminProfileDisplayEmail').textContent = registration.email;
                    document.getElementById('adminProfileDisplayPhone').textContent = registration.contact;
                    document.getElementById('adminProfileDisplayLicense').textContent = registration.license || 'Not provided';
                    document.getElementById('adminProfileDisplayDepartment').textContent = registration.department;
                    document.getElementById('adminProfileDisplayPosition').textContent = registration.position;
                    document.getElementById('adminProfileDisplayAddress').textContent = registration.address || 'Address not provided';
                    
                    const photoDisplay = document.getElementById('adminProfilePhotoDisplay');
                    if (registration.adminPhoto) {
                        photoDisplay.innerHTML = `<img src="${registration.adminPhoto}" style="width: 100%; height: 100%; object-fit: cover;" alt="Admin Photo">`;
                    } else {
                        photoDisplay.innerHTML = `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 3rem; background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; font-weight: bold;">${registration.fullName.charAt(0).toUpperCase()}</div>`;
                    }
                } else {
                    document.getElementById('adminProfileDisplay').style.display = 'none';
                    document.getElementById('adminProfileEditForm').style.display = 'none';
                    document.getElementById('adminProfileNotRegistered').style.display = 'block';
                }
            } else {
                document.getElementById('adminProfileDisplay').style.display = 'none';
                document.getElementById('adminProfileEditForm').style.display = 'none';
                document.getElementById('adminProfileNotRegistered').style.display = 'block';
            }
        }

        // Show edit admin profile
        function showEditAdminProfile() {
            document.getElementById('adminProfileDisplay').style.display = 'none';
            document.getElementById('adminProfileEditForm').style.display = 'block';
            
            const adminRegistrations = JSON.parse(localStorage.getItem('adminRegistrations') || '[]');
            const registration = adminRegistrations.find(r => r.email === currentAdminData.email);
            
            if (registration) {
                document.getElementById('editAdminFullName').value = registration.fullName;
                document.getElementById('editAdminAge').value = registration.age;
                document.getElementById('editAdminGender').value = registration.gender;
                document.getElementById('editAdminDepartment').value = registration.department;
                document.getElementById('editAdminPosition').value = registration.position;
                document.getElementById('editAdminContact').value = registration.contact;
                document.getElementById('editAdminLicense').value = registration.license || '';
                document.getElementById('editAdminAddress').value = registration.address || '';
            }
        }

        // Cancel edit admin profile
        function cancelEditAdminProfile() {
            document.getElementById('adminProfileEditForm').style.display = 'none';
            document.getElementById('adminProfileDisplay').style.display = 'block';
        }

        // Admin profile update form handling
        document.getElementById('adminProfileUpdateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const updatedData = {
                fullName: document.getElementById('editAdminFullName').value,
                age: document.getElementById('editAdminAge').value,
                gender: document.getElementById('editAdminGender').value,
                department: document.getElementById('editAdminDepartment').value,
                position: document.getElementById('editAdminPosition').value,
                contact: document.getElementById('editAdminContact').value,
                license: document.getElementById('editAdminLicense').value,
                address: document.getElementById('editAdminAddress').value
            };
            
            const photoFile = document.getElementById('editAdminPhoto').files[0];
            if (photoFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    updatedData.adminPhoto = e.target.result;
                    saveUpdatedAdminProfile(updatedData);
                };
                reader.readAsDataURL(photoFile);
            } else {
                saveUpdatedAdminProfile(updatedData);
            }
        });

        // Save updated admin profile
        function saveUpdatedAdminProfile(updatedData) {
            let adminRegistrations = JSON.parse(localStorage.getItem('adminRegistrations') || '[]');
            const regIndex = adminRegistrations.findIndex(r => r.email === currentAdminData.email);
            if (regIndex !== -1) {
                adminRegistrations[regIndex] = { ...adminRegistrations[regIndex], ...updatedData };
                localStorage.setItem('adminRegistrations', JSON.stringify(adminRegistrations));
            }
            
            if (updatedData.fullName !== currentAdminData.fullName) {
                let adminAccounts = JSON.parse(localStorage.getItem('adminAccounts') || '[]');
                const accountIndex = adminAccounts.findIndex(a => a.email === currentAdminData.email);
                if (accountIndex !== -1) {
                    adminAccounts[accountIndex].fullName = updatedData.fullName;
                    localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
                }
                currentAdminData.fullName = updatedData.fullName;
                currentAdminName = updatedData.fullName;
            }
            
            updateAdminDisplay();
            loadAdminProfile();
            cancelEditAdminProfile();
            
            alert('‚úÖ Admin profile updated successfully!');
        }

        // Load user data from actual user panel registrations (fast cached approach)
        // Refresh data automatically every 2 seconds when on user management page
        let autoRefreshInterval = null;

        function enableAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(() => {
                loadUserData();
            }, 2000); // Refresh every 2 seconds
        }

        function disableAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        function loadUserData() {
            console.log('üîµ Loading user data from localStorage...');
            
            // Get real user data from user panel (single parse, reuse)
            let userRegistrations = JSON.parse(localStorage.getItem('userRegistrations') || '[]');
            const userAccounts = JSON.parse(localStorage.getItem('userAccounts') || '[]');
            
            console.log('üìä Registrations found:', userRegistrations.length);
            console.log('üìä Accounts found:', userAccounts.length);
            
            // Get user login data from login logs
            const loginLogs = JSON.parse(localStorage.getItem('loginLogs') || '[]');
            const userLoginData = {};
            
            // Process login logs to get user login statistics (single pass, O(n))
            loginLogs.forEach(log => {
                if (log.userType === 'user' && log.success) {
                    if (!userLoginData[log.email]) {
                        userLoginData[log.email] = {
                            loginCount: 0,
                            firstLogin: log.timestamp,
                            lastLogin: log.timestamp,
                            loginDates: []
                        };
                    }
                    userLoginData[log.email].loginCount++;
                    userLoginData[log.email].lastLogin = log.timestamp;
                    userLoginData[log.email].loginDates.push(log.timestamp);
                }
            });
            
            // Merge registration and login data to get complete user information
            const allUsers = [];
            
            // Add registered users
            userRegistrations.forEach(user => {
                const account = userAccounts.find(a => a.email === user.email);
                const loginData = userLoginData[user.email];
                // Use proper registration date from user data
                let regDate = 'N/A';
                let regTime = 'N/A';
                if (user.registrationDate) {
                    regDate = user.registrationDate;
                    regTime = user.registrationTime || 'N/A';
                } else if (user.registrationTimestamp) {
                    const regDateTime = new Date(user.registrationTimestamp);
                    regDate = regDateTime.toLocaleDateString();
                    regTime = regDateTime.toLocaleTimeString();
                }
                // Ensure user has a unique ID - use from registration or generate one
                let userId = user.uniqueId;
                if (!userId || userId === 'N/A') {
                    // Generate a user ID if missing
                    userId = 'USR' + user.email.substring(0, 3).toUpperCase() + Date.now().toString().slice(-4);
                }
                allUsers.push({
                    ...user,
                    uniqueId: userId,
                    registrationDate: regDate,
                    registrationTime: regTime,
                    hasAccount: !!account,
                    lastLogin: loginData ? loginData.lastLogin : null,
                    loginCount: loginData ? loginData.loginCount : 0,
                    firstLogin: loginData ? loginData.firstLogin : null,
                    totalLoginDays: loginData ? new Set(loginData.loginDates.map(d => new Date(d).toDateString())).size : 0
                });
            });
            
            // If no users exist, show empty state
            const tableBody = document.getElementById('usersTableBody');
            
            if (allUsers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #6c757d;">
                            <div style="font-size: 3rem; margin-bottom: 15px;">üë•</div>
                            <h4>No Users Found</h4>
                            <p>Users who register through the user panel will appear here</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort users by registration date (newest first)
            allUsers.sort((a, b) => {
                const dateA = new Date(a.registrationDate || 0);
                const dateB = new Date(b.registrationDate || 0);
                return dateB - dateA;
            });
            
            let tableHTML = '';
            allUsers.forEach(user => {
                const status = user.hasAccount ? 'Active Account' : 'Registration Only';
                const statusClass = user.hasAccount ? 'status-active' : 'status-pending';
                
                // Handle user photo display with better error handling
                let photoHTML = '';
                if (user.userPhoto && user.userPhoto.trim() !== '') {
                    photoHTML = `<img src="${user.userPhoto}" class="user-photo" alt="User Photo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #3498db, #2980b9); display: none; align-items: center; justify-content: center; color: white; font-weight: bold;">${user.fullName.charAt(0).toUpperCase()}</div>`;
                } else {
                    photoHTML = `<div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #3498db, #2980b9); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2rem;">${user.fullName.charAt(0).toUpperCase()}</div>`;
                }
                
                // Display user data based on visibility setting
                const displayName = showUserData ? user.fullName : '****** (Hidden)';
                const displayEmail = showUserData ? user.email : '***@***.*** (Hidden)';
                const displayContact = showUserData ? user.contact : '***-***-**** (Hidden)';
                
                tableHTML += `
                    <tr>
                        <td>${photoHTML}</td>
                        <td>
                            <div style="font-weight: 500;">${displayName}</div>
                            <small style="color: #6c757d; font-weight: 500;">ID: ${user.uniqueId}</small>
                        </td>
                        <td>${displayEmail}</td>
                        <td>${user.age}</td>
                        <td>${user.gender}</td>
                        <td>${user.city}</td>
                        <td>${displayContact}</td>
                        <td>
                            <div style="font-weight: 500;">${user.registrationDate}</div>
                            ${user.registrationTime !== 'N/A' ? `<small style="color: #6c757d;">${user.registrationTime}</small>` : ''}
                        </td>
                        <td>
                            <button class="btn btn-info" onclick="viewUserDetails('${user.email}')" style="padding: 5px 10px; font-size: 0.8rem;">View Details</button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
        }

        // View user details with complete information
        function viewUserDetails(email) {
            const userRegistrations = JSON.parse(localStorage.getItem('userRegistrations') || '[]');
            const userAccounts = JSON.parse(localStorage.getItem('userAccounts') || '[]');
            const loginLogs = JSON.parse(localStorage.getItem('loginLogs') || '[]');
            
            // Find user from registrations first, then accounts
            let user = userRegistrations.find(u => u.email === email);
            const account = userAccounts.find(a => a.email === email);
            
            // Process login data from login logs
            const userLoginLogs = loginLogs.filter(log => log.email === email && log.userType === 'user');
            const successfulLogins = userLoginLogs.filter(log => log.success);
            const failedLogins = userLoginLogs.filter(log => !log.success);
            
            let loginData = null;
            if (successfulLogins.length > 0) {
                const loginDates = successfulLogins.map(log => log.timestamp);
                const uniqueDays = new Set(loginDates.map(d => new Date(d).toDateString())).size;
                
                loginData = {
                    loginCount: successfulLogins.length,
                    failedAttempts: failedLogins.length,
                    firstLogin: loginDates[loginDates.length - 1], // First login (oldest)
                    lastLogin: loginDates[0], // Last login (newest)
                    totalLoginDays: uniqueDays,
                    recentLogins: successfulLogins.slice(0, 5) // Last 5 successful logins
                };
            }
            
            // If no registration data, use account data
            if (!user && account) {
                user = {
                    uniqueId: account.uniqueId || 'N/A',
                    fullName: account.fullName || account.email.split('@')[0],
                    email: account.email,
                    age: account.age || 'N/A',
                    gender: account.gender || 'N/A',
                    city: account.city || 'N/A',
                    contact: account.contact || 'N/A',
                    registrationDate: account.accountCreated ? new Date(account.accountCreated).toLocaleDateString() : 'N/A',
                    registrationTime: account.accountCreated ? new Date(account.accountCreated).toLocaleTimeString() : 'N/A',
                    userPhoto: account.userPhoto || null,
                    address: account.address || 'N/A'
                };
            }
            
            // Ensure proper registration date formatting
            if (user && user.registrationTimestamp && (!user.registrationDate || user.registrationDate === 'N/A')) {
                const regDateTime = new Date(user.registrationTimestamp);
                user.registrationDate = regDateTime.toLocaleDateString();
                user.registrationTime = regDateTime.toLocaleTimeString();
            }
            
            if (user) {
                // Handle user photo display
                let photoHTML = '';
                if (user.userPhoto && user.userPhoto.trim() !== '') {
                    photoHTML = `<img src="${user.userPhoto}" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #3498db;" alt="User Photo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div style="width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, #3498db, #2980b9); display: none; align-items: center; justify-content: center; margin: 0 auto; color: white; font-weight: bold; font-size: 3rem;">${user.fullName.charAt(0).toUpperCase()}</div>`;
                } else {
                    photoHTML = `<div style="width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, #3498db, #2980b9); display: flex; align-items: center; justify-content: center; margin: 0 auto; color: white; font-weight: bold; font-size: 3rem;">${user.fullName.charAt(0).toUpperCase()}</div>`;
                }
                
                const detailsHTML = `
                    <div style="max-width: 700px;">
                        <h3 style="color: #2c3e50; margin-bottom: 25px; text-align: center;">üë§ Complete User Profile</h3>
                        
                        <div style="text-align: center; margin-bottom: 25px;">
                            ${photoHTML}
                            <h4 style="color: #2c3e50; margin-top: 15px; margin-bottom: 5px;">${user.fullName}</h4>
                            <p style="color: #6c757d;">${user.email}</p>
                            <p style="color: #888; font-size: 1rem; margin-top: 5px;"><strong>User ID:</strong> ${user.uniqueId}</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;">
                            <!-- Personal Information -->
                            <div style="background: linear-gradient(135deg, #e8f5e8, #d4edda); padding: 20px; border-radius: 15px;">
                                <h5 style="color: #155724; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                    üë§ Personal Information
                                </h5>
                                <p style="margin-bottom: 8px;"><strong>User ID:</strong> ${user.uniqueId}</p>
                                <p style="margin-bottom: 8px;"><strong>Full Name:</strong> ${user.fullName}</p>
                                <p style="margin-bottom: 8px;"><strong>Age:</strong> ${user.age} years</p>
                                <p style="margin-bottom: 8px;"><strong>Gender:</strong> ${user.gender}</p>
                                <p><strong>City:</strong> ${user.city}</p>
                            </div>
                            
                            <!-- Contact Information -->
                            <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 20px; border-radius: 15px;">
                                <h5 style="color: #1565c0; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                    üìû Contact Information
                                </h5>
                                <p style="margin-bottom: 8px;"><strong>Email:</strong> ${user.email}</p>
                                <p style="margin-bottom: 8px;"><strong>Phone:</strong> ${user.contact}</p>
                                ${user.emergencyContact ? `<p style="margin-bottom: 8px;"><strong>Emergency Contact:</strong> ${user.emergencyContact}</p>` : ''}
                                ${user.address && user.address !== 'N/A' ? `<p><strong>Address:</strong> ${user.address}</p>` : ''}
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <!-- Registration Details -->
                            <div style="background: linear-gradient(135deg, #fff3e0, #ffcc02); padding: 20px; border-radius: 15px;">
                                <h5 style="color: #e65100; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                    üìÖ Registration Details
                                </h5>
                                <p style="margin-bottom: 8px;"><strong>Registration Date:</strong> ${user.registrationDate}</p>
                                ${user.registrationTime && user.registrationTime !== 'N/A' ? `<p style="margin-bottom: 8px;"><strong>Registration Time:</strong> ${user.registrationTime}</p>` : ''}
                                <p style="margin-bottom: 8px;"><strong>Account Status:</strong> ${account ? '‚úÖ Active Account' : '‚è≥ Registration Only'}</p>
                            </div>
                            
                            <!-- Activity Information -->
                            <div style="background: linear-gradient(135deg, #f3e5f5, #e1bee7); padding: 20px; border-radius: 15px;">
                                <h5 style="color: #7b1fa2; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                    üìä Login Activity
                                </h5>
                                ${loginData ? `
                                    <p style="margin-bottom: 8px;"><strong>Total Successful Logins:</strong> ${loginData.loginCount}</p>
                                    ${loginData.failedAttempts > 0 ? `<p style="margin-bottom: 8px; color: #dc3545;"><strong>Failed Attempts:</strong> ${loginData.failedAttempts}</p>` : ''}
                                    <p style="margin-bottom: 8px;"><strong>Active Days:</strong> ${loginData.totalLoginDays} days</p>
                                    <p style="margin-bottom: 8px;"><strong>First Login:</strong> ${new Date(loginData.firstLogin).toLocaleDateString()} ${new Date(loginData.firstLogin).toLocaleTimeString()}</p>
                                    <p style="margin-bottom: 8px;"><strong>Last Login:</strong> ${new Date(loginData.lastLogin).toLocaleDateString()} ${new Date(loginData.lastLogin).toLocaleTimeString()}</p>
                                ` : `<p style=\"color: #6c757d; font-size: 0.9rem;\">No login activity recorded.</p>`}
                            </div>
                        </div>
                        
                        ${loginData && loginData.recentLogins.length > 0 ? `
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-top: 20px;">
                                <h5 style="color: #2c3e50; margin-bottom: 15px;">üïí Recent Login History</h5>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    ${loginData.recentLogins.map(login => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e9ecef;">
                                            <span style="color: #495057;">${new Date(login.timestamp).toLocaleDateString()}</span>
                                            <span style="color: #6c757d; font-size: 0.9rem;">${new Date(login.timestamp).toLocaleTimeString()}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${user.medicalHistory ? `
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-top: 20px;">
                                <h5 style="color: #2c3e50; margin-bottom: 15px;">üè• Medical History</h5>
                                <p>${user.medicalHistory}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                // Create enhanced modal
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.6); display: flex; align-items: center; 
                    justify-content: center; z-index: 2000; padding: 20px;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 20px; padding: 30px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                        ${detailsHTML}
                        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #f1f2f6;">
                            <button class="btn btn-primary" onclick="this.closest('.modal').remove()" style="padding: 12px 30px;">
                                ‚úÖ Close Profile
                            </button>
                        </div>
                    </div>
                `;
                
                modal.className = 'modal';
                document.body.appendChild(modal);
                
                // Close on background click
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
                // Close on Escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        modal.remove();
                    }
                });
            } else {
                alert('User details not found!');
            }
        }

        // Toggle user data visibility
        function toggleUserDataVisibility() {
            showUserData = !showUserData;
            const toggleBtn = document.getElementById('toggleUserDataBtn');
            
            if (showUserData) {
                toggleBtn.innerHTML = 'üôà Hide User Data';
                toggleBtn.className = 'btn btn-warning';
            } else {
                toggleBtn.innerHTML = 'üëÅÔ∏è Show User Data';
                toggleBtn.className = 'btn btn-warning';
            }
            
            // Reload user data with new visibility setting
            loadUserData();
        }

        // Filter users
        function filterUsers() {
            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#usersTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Refresh user data
        function refreshUserData() {
            loadUserData();
            updateAdminStats();
            alert('‚úÖ User data refreshed successfully!');
        }

        // Export user data
        function exportUserData() {
            const userRegistrations = JSON.parse(localStorage.getItem('userRegistrations') || '[]');
            
            if (userRegistrations.length === 0) {
                alert('No user data to export!');
                return;
            }
            
            // Create CSV content
            const headers = ['Name', 'Email', 'Age', 'Gender', 'City', 'Contact', 'Registration Date'];
            const csvContent = [
                headers.join(','),
                ...userRegistrations.map(user => [
                    user.fullName,
                    user.email,
                    user.age,
                    user.gender,
                    user.city,
                    user.contact,
                    user.registrationDate
                ].join(','))
            ].join('\n');
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `user_data_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('‚úÖ User data exported successfully!');
        }

        // Load patient options for CT scan upload
        function loadPatientOptions() {
            const userRegistrations = JSON.parse(localStorage.getItem('userRegistrations') || '[]');
            const patientSelect = document.getElementById('patientSelect');
            
            patientSelect.innerHTML = '<option value="">Choose a patient...</option>';
            
            userRegistrations.forEach(user => {
                const option = document.createElement('option');
                option.value = user.email;
                option.textContent = `${user.fullName} (${user.uniqueId})`;
                patientSelect.appendChild(option);
            });
        }

        // Initialize CT scan form
        function initializeCTScanForm() {
            generatePatientId();
            setCurrentDateTime();
        }

        // Generate patient ID
        function generatePatientId() {
            const patientId = 'PAT' + Date.now().toString().slice(-6) + Math.random().toString(36).substr(2, 4).toUpperCase();
            document.getElementById('patientId').value = patientId;
        }

        // Set current date and time
        function setCurrentDateTime() {
            const now = new Date();
            const currentDate = now.toISOString().split('T')[0];
            const currentTime = now.toTimeString().split(' ')[0].slice(0, 5);
            
            document.getElementById('scanDate').value = currentDate;
            document.getElementById('scanTime').value = currentTime;
        }

        // Tab functionality
        function showTab(tabId, buttonElement) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab and mark button as active
            document.getElementById(tabId).classList.add('active');
            buttonElement.classList.add('active');
            
            // Load data for specific tabs
            if (tabId === 'historyTab') {
                loadScanHistory();
            }
        }

        // CT Scan upload functionality
        document.getElementById('ctScanInput').addEventListener('change', handleCTScanFile);
        
        const dropZone = document.getElementById('ctScanDropZone');
        
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('ctScanInput').files = files;
                handleCTScanFile({ target: { files: files } });
            }
        });
        
        dropZone.addEventListener('click', function() {
            document.getElementById('ctScanInput').click();
        });

        // Handle CT scan file
        function handleCTScanFile(event) {
            const file = event.target.files[0];
            const previewContainer = document.getElementById('scanPreviewContainer');
            const analyzeBtn = document.getElementById('analyzeBtn');
            
            if (!file) {
                previewContainer.style.display = 'none';
                analyzeBtn.disabled = true;
                return;
            }
            
            // Check file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('File size too large. Please select a file smaller than 10MB.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                previewContainer.style.display = 'block';
                document.getElementById('scanPreviewImage').innerHTML = `
                    <img src="${e.target.result}" style="max-width: 100%; max-height: 300px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);" alt="CT Scan Preview">
                    <p style="color: #2c3e50; font-weight: 500; margin-top: 15px;">${file.name}</p>
                    <p style="color: #6c757d; font-size: 0.9rem;">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                `;
                
                analyzeBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        }

        // Analyze CT scan with Python ML model
        async function analyzeCTScan() {
            // Validate form
            const requiredFields = ['patientFullName', 'patientAge', 'patientContact', 'patientEmail', 'patientAddress'];
            const patientPhoto = document.getElementById('patientPhoto').files[0];
            const ctScanFile = document.getElementById('ctScanInput').files[0];
            
            for (let field of requiredFields) {
                if (!document.getElementById(field).value) {
                    alert(`Please fill in the ${field.replace('patient', '').replace(/([A-Z])/g, ' $1').toLowerCase()} field.`);
                    return;
                }
            }
            
            if (!patientPhoto) {
                alert('Please upload patient photo.');
                return;
            }
            
            if (!ctScanFile) {
                alert('Please upload CT scan image.');
                return;
            }
            
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<div class="loading"></div>Connecting to ML Model...';
            
            try {
                // Call Python ML model for analysis
                await performMLAnalysis();
            } catch (error) {
                console.error('ML Analysis Error:', error);
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = 'ü§ñ Analyze CT Scan with AI';
                alert('‚ùå ML Model connection failed. Please ensure Python ML service is running on localhost:5000');
            }
        }

        // Perform ML analysis with Python backend
        async function performMLAnalysis() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.innerHTML = '<div class="loading"></div>Processing with ML Model...';
            
            const patientData = {
                id: document.getElementById('patientId').value,
                fullName: document.getElementById('patientFullName').value,
                age: document.getElementById('patientAge').value,
                contact: document.getElementById('patientContact').value,
                email: document.getElementById('patientEmail').value,
                address: document.getElementById('patientAddress').value,
                scanDate: document.getElementById('scanDate').value,
                scanTime: document.getElementById('scanTime').value,
                analyzedBy: currentAdminName,
                analysisDate: new Date().toISOString()
            };
            
            // Get uploaded files
            const patientPhoto = document.getElementById('patientPhoto').files[0];
            const ctScanFile = document.getElementById('ctScanInput').files[0];
            
            // Convert files to base64
            const patientPhotoBase64 = await fileToBase64(patientPhoto);
            const ctScanBase64 = await fileToBase64(ctScanFile);
            
            patientData.patientPhoto = patientPhotoBase64;
            patientData.ctScanImage = ctScanBase64;
            
            try {
                // Send to Python ML model
                const response = await fetch('http://localhost:5000/analyze_ct_scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ct_scan_image: ctScanBase64,
                        patient_data: patientData
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const mlResults = await response.json();
                
                // Process ML results
                patientData.predictions = mlResults.predictions;
                patientData.topPrediction = mlResults.top_prediction;
                patientData.confidence = mlResults.confidence;
                patientData.mlModelUsed = mlResults.model_info;
                
                displayAnalysisResults(patientData);
                
                // Save analysis data
                const ctAnalyses = JSON.parse(localStorage.getItem('ctAnalyses') || '[]');
                ctAnalyses.push(patientData);
                localStorage.setItem('ctAnalyses', JSON.stringify(ctAnalyses));
                
                // Update stats
                updateAdminStats();
                
            } catch (error) {
                console.error('ML Model Error:', error);
                
                
            }
        }
        
        // Helper function to convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        // Perform AI analysis simulation (fallback)
        function performAIAnalysis() {
            const patientData = {
                id: document.getElementById('patientId').value,
                fullName: document.getElementById('patientFullName').value,
                age: document.getElementById('patientAge').value,
                contact: document.getElementById('patientContact').value,
                email: document.getElementById('patientEmail').value,
                address: document.getElementById('patientAddress').value,
                scanDate: document.getElementById('scanDate').value,
                scanTime: document.getElementById('scanTime').value,
                analyzedBy: currentAdminName,
                analysisDate: new Date().toISOString()
            };
            
            // Get uploaded files
            const patientPhoto = document.getElementById('patientPhoto').files[0];
            const ctScanFile = document.getElementById('ctScanInput').files[0];
            
            const patientPhotoReader = new FileReader();
            const ctScanReader = new FileReader();
            
            patientPhotoReader.onload = function(e) {
                patientData.patientPhoto = e.target.result;
                
                ctScanReader.onload = function(e) {
                    patientData.ctScanImage = e.target.result;
                    
                    // Simulate AI prediction
                    const predictions = [
                        { condition: 'Normal', probability: 0.85, severity: 'normal' },
                        { condition: 'Pneumonia', probability: 0.12, severity: 'abnormal' },
                        { condition: 'COVID-19', probability: 0.08, severity: 'abnormal' },
                        { condition: 'Lung Cancer', probability: 0.03, severity: 'critical' },
                        { condition: 'Tuberculosis', probability: 0.05, severity: 'abnormal' }
                    ];
                    
                    // Sort by probability
                    predictions.sort((a, b) => b.probability - a.probability);
                    const topPrediction = predictions[0];
                    
                    patientData.predictions = predictions;
                    patientData.topPrediction = topPrediction;
                    
                    displayAnalysisResults(patientData);
                    
                    // Save analysis data
                    const ctAnalyses = JSON.parse(localStorage.getItem('ctAnalyses') || '[]');
                    ctAnalyses.push(patientData);
                    localStorage.setItem('ctAnalyses', JSON.stringify(ctAnalyses));
                    
                    // Update stats
                    updateAdminStats();
                };
                ctScanReader.readAsDataURL(ctScanFile);
            };
            patientPhotoReader.readAsDataURL(patientPhoto);
        }

        // Display analysis results
        function displayAnalysisResults(data) {
            const resultsDiv = document.getElementById('analysisResults');
            const topPrediction = data.topPrediction;
            
            let severityClass = 'normal';
            let severityIcon = '‚úÖ';
            let severityText = 'Normal';
            
            if (topPrediction.severity === 'abnormal') {
                severityClass = 'abnormal';
                severityIcon = '‚ö†Ô∏è';
                severityText = 'Abnormal';
            } else if (topPrediction.severity === 'critical') {
                severityClass = 'critical';
                severityIcon = 'üö®';
                severityText = 'Critical';
            }
            
            const recommendations = getHealthRecommendations(topPrediction.condition);
            
            resultsDiv.innerHTML = `
                <div class="analysis-result">
                    <h3 style="color: #2c3e50; margin-bottom: 25px; text-align: center;">ü§ñ AI Analysis Results</h3>
                    
                    <!-- Patient Information -->
                    <div class="patient-info-card">
                        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 15px;">
                            <img src="${data.patientPhoto}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #2196F3;" alt="Patient Photo">
                            <div>
                                <h4 style="color: #1976D2; margin-bottom: 5px;">${data.fullName}</h4>
                                <p style="color: #424242; margin-bottom: 3px;"><strong>Patient ID:</strong> ${data.id}</p>
                                <p style="color: #424242; margin-bottom: 3px;"><strong>Age:</strong> ${data.age} years</p>
                                <p style="color: #424242;"><strong>Scan Type:</strong> ${data.scanType}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CT Scan Image -->
                    <div style="text-align: center; margin-bottom: 25px;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">üì∏ CT Scan Image</h4>
                        <img src="${data.ctScanImage}" style="max-width: 100%; max-height: 400px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);" alt="CT Scan">
                    </div>
                    
                    <!-- AI Prediction -->
                    <div class="prediction-card ${severityClass}">
                        <h3 style="margin-bottom: 15px;">${severityIcon} AI Prediction: ${topPrediction.condition}</h3>
                        <p style="font-size: 1.2rem; margin-bottom: 10px;"><strong>Confidence:</strong> ${(topPrediction.probability * 100).toFixed(1)}%</p>
                        <p style="font-size: 1.1rem;"><strong>Status:</strong> ${severityText}</p>
                    </div>
                    
                    <!-- All Predictions -->
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">üìä Detailed Analysis</h4>
                        ${data.predictions.map(pred => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px;">
                                <span style="font-weight: 500;">${pred.condition}</span>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 100px; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                                        <div style="width: ${pred.probability * 100}%; height: 100%; background: ${pred.severity === 'critical' ? '#dc3545' : pred.severity === 'abnormal' ? '#ffc107' : '#28a745'};"></div>
                                    </div>
                                    <span style="font-weight: 500; min-width: 50px;">${(pred.probability * 100).toFixed(1)}%</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Health Recommendations -->
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">üí° Health Recommendations</h4>
                        ${recommendations.map(rec => `
                            <div class="recommendation-card">
                                <h5 style="color: #e74c3c; margin-bottom: 10px;">${rec.title}</h5>
                                <p style="color: #495057;">${rec.description}</p>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Download Section -->
                    <div class="download-section">
                        <h4 style="margin-bottom: 15px;">üìÑ Download Professional Report</h4>
                        <p style="margin-bottom: 20px; opacity: 0.9;">Generate and download a comprehensive medical report</p>
                        <button class="btn btn-success" onclick="downloadPDFReport('${data.id}')" style="background: white; color: #2c3e50; font-weight: 600;">
                            üì• Download PDF Report
                        </button>
                    </div>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
            
            // Reset analyze button
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = 'ü§ñ Analyze CT Scan with AI';
            
            // Scroll to results
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // Get health recommendations based on condition
        function getHealthRecommendations(condition) {
            const recommendations = {
                'Normal': [
                    {
                        title: 'Maintain Healthy Lifestyle',
                        description: 'Continue with regular exercise, balanced diet, and adequate sleep to maintain good lung health.'
                    },
                    {
                        title: 'Regular Check-ups',
                        description: 'Schedule routine medical check-ups every 6-12 months to monitor your health status.'
                    },
                    {
                        title: 'Avoid Smoking',
                        description: 'Stay away from smoking and secondhand smoke to protect your respiratory system.'
                    }
                ],
                'Pneumonia': [
                    {
                        title: 'Immediate Medical Attention',
                        description: 'Consult with a pulmonologist immediately for proper antibiotic treatment and monitoring.'
                    },
                    {
                        title: 'Rest and Hydration',
                        description: 'Get plenty of rest and stay well-hydrated to help your body fight the infection.'
                    },
                    {
                        title: 'Follow-up Care',
                        description: 'Schedule follow-up appointments to monitor recovery and prevent complications.'
                    }
                ],
                'COVID-19': [
                    {
                        title: 'Isolation and Monitoring',
                        description: 'Self-isolate immediately and monitor symptoms closely. Contact healthcare provider for guidance.'
                    },
                    {
                        title: 'Supportive Care',
                        description: 'Rest, stay hydrated, and take medications as prescribed by your healthcare provider.'
                    },
                    {
                        title: 'Emergency Signs',
                        description: 'Seek immediate medical attention if experiencing difficulty breathing or chest pain.'
                    }
                ],
                'Lung Cancer': [
                    {
                        title: 'Urgent Oncology Referral',
                        description: 'Schedule immediate consultation with an oncologist for comprehensive evaluation and staging.'
                    },
                    {
                        title: 'Additional Testing',
                        description: 'Prepare for additional tests including PET scan, biopsy, and molecular testing.'
                    },
                    {
                        title: 'Support System',
                        description: 'Build a strong support network including family, friends, and healthcare team.'
                    }
                ],
                'Tuberculosis': [
                    {
                        title: 'Anti-TB Treatment',
                        description: 'Start anti-tuberculosis medication regimen as prescribed by infectious disease specialist.'
                    },
                    {
                        title: 'Infection Control',
                        description: 'Follow strict isolation protocols to prevent transmission to others.'
                    },
                    {
                        title: 'Nutritional Support',
                        description: 'Maintain good nutrition and take supplements as recommended by your doctor.'
                    }
                ]
            };
            
            return recommendations[condition] || recommendations['Normal'];
        }

        // Load scan history
        function loadScanHistory() {
            const ctAnalyses = JSON.parse(localStorage.getItem('ctAnalyses') || '[]');
            const historyContainer = document.getElementById('scanHistoryContainer');
            
            if (ctAnalyses.length === 0) {
                historyContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <h4>No scan history available</h4>
                        <p>Completed CT scan analyses will appear here</p>
                    </div>
                `;
                return;
            }
            
            let historyHTML = '';
            ctAnalyses.reverse().forEach(analysis => {
                const analysisDate = new Date(analysis.analysisDate).toLocaleDateString();
                const analysisTime = new Date(analysis.analysisDate).toLocaleTimeString();
                
                historyHTML += `
                    <div class="scan-history-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <img src="${analysis.patientPhoto}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;" alt="Patient">
                                <div>
                                    <h4 style="color: #2c3e50; margin-bottom: 5px;">${analysis.fullName}</h4>
                                    <p style="color: #6c757d; margin-bottom: 3px;">ID: ${analysis.id}</p>
                                    <p style="color: #6c757d; font-size: 0.9rem;">Age: ${analysis.age} | ${analysis.scanType}</p>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <span style="background: ${analysis.topPrediction.severity === 'critical' ? '#dc3545' : analysis.topPrediction.severity === 'abnormal' ? '#ffc107' : '#28a745'}; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem;">
                                    ${analysis.topPrediction.condition}
                                </span>
                                <p style="color: #6c757d; font-size: 0.8rem; margin-top: 5px;">${analysisDate}</p>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="color: #495057;"><strong>Confidence:</strong> ${(analysis.topPrediction.probability * 100).toFixed(1)}%</p>
                                <p style="color: #495057; font-size: 0.9rem;">Analyzed by: ${analysis.analyzedBy}</p>
                            </div>
                            <button class="btn btn-primary" onclick="downloadPDFReport('${analysis.id}')" style="padding: 8px 15px; font-size: 0.9rem;">
                                üì• Download Report
                            </button>
                        </div>
                    </div>
                `;
            });
            
            historyContainer.innerHTML = historyHTML;
        }

        // Filter scan history
        function filterScanHistory() {
            const searchTerm = document.getElementById('historySearchInput').value.toLowerCase();
            const historyCards = document.querySelectorAll('.scan-history-card');
            
            historyCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // Refresh scan history
        function refreshScanHistory() {
            loadScanHistory();
            document.getElementById('historySearchInput').value = '';
            alert('‚úÖ Scan history refreshed successfully!');
        }

        // Log login attempt
        function logLoginAttempt(email, userType, success) {
            if (!success) return; // Only store successful logins
            const key = userType === 'admin' ? 'adminLoginLogs' : 'userLoginLogs';
            const loginLogs = JSON.parse(localStorage.getItem(key) || '[]');
            const logEntry = {
                id: Date.now(),
                email: email,
                userType: userType, // 'user' or 'admin'
                success: success,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString()
            };
            loginLogs.unshift(logEntry);
            if (loginLogs.length > 100) {
                loginLogs.splice(100);
            }
            localStorage.setItem(key, JSON.stringify(loginLogs));
        }

        // Load login logs
        function loadLoginLogs() {
            // User logs
            let userLogs = JSON.parse(localStorage.getItem('userLoginLogs') || '[]');
            const userLogsContainer = document.getElementById('userLoginLogsContainer');
            if (!userLogs || userLogs.length === 0) {
                userLogsContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">No user login logs available.</div>';
            } else {
                let userLogsHTML = '';
                userLogs.sort((a, b) => b.timestamp.localeCompare(a.timestamp));
                userLogs.forEach(log => {
                    const statusClass = log.success ? 'log-success' : 'log-failed';
                    const statusText = log.success ? 'Success' : 'Failed';
                    let displayDate = log.date || 'Unknown date';
                    let displayTime = log.time || 'Unknown time';
                    if (log.timestamp) {
                        const logDate = new Date(log.timestamp);
                        displayDate = logDate.toLocaleDateString();
                        displayTime = logDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }
                    userLogsHTML += `
                        <div class="log-entry">
                            <div>
                                <div class="log-user">üë§ ${log.email}</div>
                                <div class="log-time">${displayDate} at ${displayTime}</div>
                            </div>
                            <div>
                                <span class="log-status ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                    `;
                });
                userLogsContainer.innerHTML = userLogsHTML;
            }

            // Admin logs
            let adminLogs = JSON.parse(localStorage.getItem('adminLoginLogs') || '[]');
            const adminLogsContainer = document.getElementById('adminLoginLogsContainer');
            if (!adminLogs || adminLogs.length === 0) {
                adminLogsContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">No admin login logs available.</div>';
            } else {
                let adminLogsHTML = '';
                adminLogs.sort((a, b) => b.timestamp.localeCompare(a.timestamp));
                adminLogs.forEach(log => {
                    const statusClass = log.success ? 'log-success' : 'log-failed';
                    const statusText = log.success ? 'Success' : 'Failed';
                    let displayDate = log.date || 'Unknown date';
                    let displayTime = log.time || 'Unknown time';
                    if (log.timestamp) {
                        const logDate = new Date(log.timestamp);
                        displayDate = logDate.toLocaleDateString();
                        displayTime = logDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }
                    adminLogsHTML += `
                        <div class="log-entry">
                            <div>
                                <div class="log-user">üë®‚Äçüíº ${log.email}</div>
                                <div class="log-time">${displayDate} at ${displayTime}</div>
                            </div>
                            <div>
                                <span class="log-status ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                    `;
                });
                adminLogsContainer.innerHTML = adminLogsHTML;
            }
        }

        // Filter logs
        function filterLogs() {
            const filter = document.getElementById('logFilter').value;
            const loginLogs = JSON.parse(localStorage.getItem('loginLogs') || '[]');
            const logsContainer = document.getElementById('loginLogsContainer');
            
            let filteredLogs = loginLogs;
            
            switch (filter) {
                case 'user':
                    filteredLogs = loginLogs.filter(log => log.userType === 'user');
                    break;
                case 'admin':
                    filteredLogs = loginLogs.filter(log => log.userType === 'admin');
                    break;
                case 'success':
                    filteredLogs = loginLogs.filter(log => log.success === true);
                    break;
                case 'failed':
                    filteredLogs = loginLogs.filter(log => log.success === false);
                    break;
            }
            
            if (filteredLogs.length === 0) {
                logsContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">No logs match the selected filter.</div>';
                return;
            }
            
            let logsHTML = '';
            filteredLogs.forEach(log => {
                const statusClass = log.success ? 'log-success' : 'log-failed';
                const statusText = log.success ? 'Success' : 'Failed';
                const userTypeIcon = log.userType === 'admin' ? 'üë®‚Äçüíº' : 'üë§';
                
                // Format date and time properly
                let displayDate = log.date || 'Unknown date';
                let displayTime = log.time || 'Unknown time';
                
                // If we have timestamp, use it to format date/time properly
                if (log.timestamp) {
                    const logDate = new Date(log.timestamp);
                    displayDate = logDate.toLocaleDateString();
                    displayTime = logDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }
                
                logsHTML += `
                    <div class="log-entry">
                        <div>
                            <div class="log-user">${userTypeIcon} ${log.email}</div>
                            <div class="log-time">${displayDate} at ${displayTime}</div>
                        </div>
                        <div>
                            <span class="log-status ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                `;
            });
            
            logsContainer.innerHTML = logsHTML;
        }

        // Refresh login logs
        function refreshLoginLogs() {
            loadLoginLogs();
            document.getElementById('logFilter').value = 'all';
            alert('‚úÖ Login logs refreshed successfully!');
        }

      

        // Small number animation helper (non-blocking)
        function animateCount(id, target, duration = 700) {
            const el = document.getElementById(id);
            if (!el) return;
            const start = parseInt(String(el.textContent).replace(/[^0-9]/g, '')) || 0;
            const startTime = performance.now();

            function step(now) {
                const progress = Math.min((now - startTime) / duration, 1);
                const value = Math.floor(start + (target - start) * progress);
                el.textContent = value;
                if (progress < 1) requestAnimationFrame(step);
                else el.textContent = target;
            }

            requestAnimationFrame(step);
        }

        // Update admin statistics with real data (uses animateCount)
        function updateAdminStats() {
            const userAccounts = JSON.parse(localStorage.getItem('userAccounts') || '[]');
            const userRegistrations = JSON.parse(localStorage.getItem('userRegistrations') || '[]');
            const adminAccounts = JSON.parse(localStorage.getItem('adminAccounts') || '[]');
            const ctAnalyses = JSON.parse(localStorage.getItem('ctAnalyses') || '[]');

            // Calculate total unique users (from both registrations and accounts)
            const allUserEmails = new Set([
                ...(userRegistrations.map(u => u.email)),
                ...(userAccounts.map(u => u.email))
            ]);

            animateCount('totalUsers', allUserEmails.size);
            animateCount('registeredUsers', userRegistrations.length);
            animateCount('totalAdmins', adminAccounts.length);
            animateCount('totalScans', ctAnalyses.length);

            // Update recent activity with real data
            const recentActivityDiv = document.getElementById('recentActivity');
            const recentRegistrations = userRegistrations.slice(-3);
            const recentAnalyses = ctAnalyses.slice(-2);

            // Get recent user logins from login logs
            const loginLogs = JSON.parse(localStorage.getItem('loginLogs') || '[]');
            const recentUserLogins = loginLogs
                .filter(log => log.userType === 'user' && log.success)
                .slice(0, 3);

            let activityHTML = '';

            if (recentRegistrations.length > 0) {
                activityHTML += '<h5 style="color: #2c3e50; margin-bottom: 10px;">üìù Recent Registrations:</h5>';
                recentRegistrations.forEach(user => {
                    let regDate = 'Unknown date';
                    if (user.registrationDate && user.registrationDate !== 'N/A') {
                        regDate = user.registrationDate;
                    } else if (user.registrationTimestamp) {
                        regDate = new Date(user.registrationTimestamp).toLocaleDateString();
                    }
                    activityHTML += `<p style="margin-bottom: 5px; color: #495057;">‚Ä¢ ${user.fullName || user.email} registered on ${regDate}</p>`;
                });
            }

            if (recentAnalyses.length > 0) {
                activityHTML += '<h5 style="color: #2c3e50; margin: 15px 0 10px 0;">üè• Recent CT Scans:</h5>';
                recentAnalyses.forEach(analysis => {
                    const analysisDate = analysis.analysisDate ? new Date(analysis.analysisDate).toLocaleDateString() : (analysis.scanDate || 'N/A');
                    activityHTML += `<p style="margin-bottom: 5px; color: #495057;">‚Ä¢ ${analysis.scanType || 'CT Scan'} analyzed for ${analysis.fullName || analysis.id} on ${analysisDate}</p>`;
                });
            }

            if (recentUserLogins.length > 0) {
                activityHTML += '<h5 style="color: #2c3e50; margin: 15px 0 10px 0;">üîê Recent User Logins:</h5>';
                recentUserLogins.forEach(login => {
                    const loginDate = new Date(login.timestamp).toLocaleDateString();
                    const loginTime = new Date(login.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    activityHTML += `<p style="margin-bottom: 5px; color: #495057;">‚Ä¢ ${login.email} logged in on ${loginDate} at ${loginTime}</p>`;
                });
            }

            if (activityHTML === '') {
                activityHTML = '<p style="color: #6c757d;">No recent activity. Users from the user panel will appear here once they register or login.</p>';
            }

            if (recentActivityDiv) recentActivityDiv.innerHTML = activityHTML;
        }

        // Navigation
        function showSection(sectionId) {
            if (sectionId === 'adminProfile' && !adminRegistered) {
                alert('Please complete admin registration first to access profile.');
                return;
            }

            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => section.classList.remove('active'));
            
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            
            document.getElementById(sectionId).classList.add('active');
            
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Load section-specific data
            if (sectionId === 'adminProfile') {
                loadAdminProfile();
            } else if (sectionId === 'userManagement') {
                loadUserData();
            } else if (sectionId === 'ctScanUpload') {
                initializeCTScanForm();
            } else if (sectionId === 'loginLogs') {
                loadLoginLogs();
            }
            
            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
            }
        }

        // Mobile sidebar toggle
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Log logout for admin if logged in
                if (isAdminLoggedIn && currentAdminData && currentAdminData.email) {
                    logLoginAttempt(currentAdminData.email, 'admin', false); // false = logout
                }
                // Log logout for user if user session exists
                const userSession = localStorage.getItem('userSession');
                if (userSession) {
                    const user = JSON.parse(userSession);
                    if (user && user.email) {
                        logLoginAttempt(user.email, 'user', false); // false = logout
                    }
                    localStorage.removeItem('userSession');
                }
                localStorage.removeItem('adminSession');
                currentAdminData = null;
                currentAdminName = '';
                isAdminLoggedIn = false;
                adminRegistered = false;
                document.getElementById('adminProfileNav').classList.add('disabled');
                document.getElementById('adminProfileNav').style.opacity = '0.5';
                document.getElementById('adminProfileNav').style.cursor = 'not-allowed';
                showLoginPage();
                document.getElementById('loginForm').reset();
                document.getElementById('loginMessage').innerHTML = '';
                showLoginForm();
                alert('Logged out successfully!');
            }
// User login form handling (add this if not present)
const userLoginForm = document.getElementById('userLoginForm');
if (userLoginForm) {
    userLoginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('userLoginEmail').value;
        const password = document.getElementById('userLoginPassword').value;
        const messageDiv = document.getElementById('userLoginMessage');
        const userAccounts = JSON.parse(localStorage.getItem('userAccounts') || '[]');
        const user = userAccounts.find(a => a.email === email && a.password === password);
        if (user) {
            logLoginAttempt(email, 'user', true);
            localStorage.setItem('userSession', JSON.stringify({ email: user.email, loginTime: new Date().toISOString() }));
            messageDiv.innerHTML = '<div style="color: #27ae60; margin-top: 15px;">‚úÖ User login successful!</div>';
            // Add your user dashboard show logic here
        } else {
            logLoginAttempt(email, 'user', false);
            messageDiv.innerHTML = '<div style="color: #e74c3c; margin-top: 15px;">‚ùå Invalid user credentials!</div>';
        }
    });
}
        }

        // Download PDF report with images
        function downloadPDFReport(patientId) {
            const ctAnalyses = JSON.parse(localStorage.getItem('ctAnalyses') || '[]');
            const analysis = ctAnalyses.find(a => a.id === patientId);
            
            if (!analysis) {
                alert('Analysis data not found!');
                return;
            }
            
            // Create PDF using jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Hospital Header
            doc.setFillColor(231, 76, 60);
            doc.rect(0, 0, 210, 30, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('MEDDASH MEDICAL CENTER', 105, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.text('Advanced CT Scan Analysis Report', 105, 22, { align: 'center' });
            
            // Reset text color
            doc.setTextColor(0, 0, 0);
            
            // Report Header
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('CT SCAN ANALYSIS REPORT', 20, 45);
            
            // Report Info
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            const reportDate = new Date().toLocaleDateString();
            const reportTime = new Date().toLocaleTimeString();
            doc.text(`Report Generated: ${reportDate} at ${reportTime}`, 20, 52);
            doc.text(`Report ID: RPT${Date.now()}`, 20, 57);
            doc.text(`ML Model: ${analysis.mlModelUsed || 'AI Analysis System v1.0'}`, 20, 62);
            
            // Patient Photo
            if (analysis.patientPhoto) {
                try {
                    doc.addImage(analysis.patientPhoto, 'JPEG', 160, 65, 30, 30);
                    doc.setFontSize(8);
                    doc.text('Patient Photo', 165, 100);
                } catch (error) {
                    console.log('Error adding patient photo to PDF:', error);
                }
            }
            
            // Patient Information Section
            doc.setFillColor(240, 240, 240);
            doc.rect(15, 105, 180, 8, 'F');
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('PATIENT INFORMATION', 20, 110);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            let yPos = 120;
            
            doc.text(`Patient Name: ${analysis.fullName}`, 20, yPos);
            doc.text(`Patient ID: ${analysis.id}`, 120, yPos);
            yPos += 6;
            
            doc.text(`Age: ${analysis.age} years`, 20, yPos);
            doc.text(`Contact: ${analysis.contact}`, 120, yPos);
            yPos += 6;
            
            doc.text(`Email: ${analysis.email}`, 20, yPos);
            yPos += 6;
            
            doc.text(`Address: ${analysis.address}`, 20, yPos);
            yPos += 10;
            
            // Scan Information Section
            doc.setFillColor(240, 240, 240);
            doc.rect(15, yPos, 180, 8, 'F');
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('SCAN INFORMATION', 20, yPos + 5);
            yPos += 15;
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Scan Type: ${analysis.scanType}`, 20, yPos);
            doc.text(`Scan Date: ${analysis.scanDate}`, 120, yPos);
            yPos += 6;
            
            doc.text(`Scan Time: ${analysis.scanTime}`, 20, yPos);
            doc.text(`Analyzed By: ${analysis.analyzedBy}`, 120, yPos);
            yPos += 6;
            
            if (analysis.clinicalNotes) {
                const clinicalLines = doc.splitTextToSize(`Clinical Notes: ${analysis.clinicalNotes}`, 170);
                doc.text(clinicalLines, 20, yPos);
                yPos += clinicalLines.length * 4 + 6;
            }
            yPos += 10;
            
            // CT Scan Image Section
            if (analysis.ctScanImage) {
                doc.setFillColor(240, 240, 240);
                doc.rect(15, yPos, 180, 8, 'F');
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('CT SCAN IMAGE', 20, yPos + 5);
                yPos += 15;
                
                try {
                    // Add CT scan image to PDF
                    const imgWidth = 120;
                    const imgHeight = 80;
                    const imgX = (210 - imgWidth) / 2; // Center the image
                    
                    doc.addImage(analysis.ctScanImage, 'JPEG', imgX, yPos, imgWidth, imgHeight);
                    yPos += imgHeight + 10;
                    
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text('CT Scan Image - Analyzed by AI/ML Model', 105, yPos, { align: 'center' });
                    yPos += 15;
                } catch (error) {
                    console.log('Error adding CT scan image to PDF:', error);
                    doc.setFontSize(10);
                    doc.text('CT Scan Image: [Image could not be embedded]', 20, yPos);
                    yPos += 15;
                }
            }
            
            // AI Analysis Results Section
            doc.setFillColor(240, 240, 240);
            doc.rect(15, yPos, 180, 8, 'F');
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('AI ANALYSIS RESULTS', 20, yPos + 5);
            yPos += 15;
            
            // Primary Diagnosis
            const topPrediction = analysis.topPrediction;
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            
            if (topPrediction.severity === 'critical') {
                doc.setTextColor(220, 53, 69);
            } else if (topPrediction.severity === 'abnormal') {
                doc.setTextColor(255, 193, 7);
            } else {
                doc.setTextColor(40, 167, 69);
            }
            
            doc.text(`Primary Diagnosis: ${topPrediction.condition}`, 20, yPos);
            yPos += 8;
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Confidence Level: ${(topPrediction.probability * 100).toFixed(1)}%`, 20, yPos);
            yPos += 10;
            
            // Detailed Analysis
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('Detailed Analysis:', 20, yPos);
            yPos += 8;
            
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            analysis.predictions.forEach(pred => {
                doc.text(`‚Ä¢ ${pred.condition}: ${(pred.probability * 100).toFixed(1)}%`, 25, yPos);
                yPos += 5;
            });
            yPos += 10;
            
            // Health Recommendations Section
            doc.setFillColor(240, 240, 240);
            doc.rect(15, yPos, 180, 8, 'F');
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('HEALTH RECOMMENDATIONS', 20, yPos + 5);
            yPos += 15;
            
            const recommendations = getHealthRecommendations(topPrediction.condition);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            recommendations.forEach((rec, index) => {
                doc.setFont('helvetica', 'bold');
                doc.text(`${index + 1}. ${rec.title}`, 20, yPos);
                yPos += 5;
                
                doc.setFont('helvetica', 'normal');
                const lines = doc.splitTextToSize(rec.description, 170);
                doc.text(lines, 25, yPos);
                yPos += lines.length * 4 + 5;
            });
            
            // Add new page if needed for remaining content
            if (yPos > 220) {
                doc.addPage();
                yPos = 20;
            }
            
            // Disclaimer Section
            yPos += 10;
            doc.setFillColor(255, 243, 205);
            doc.rect(15, yPos, 180, 25, 'F');
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('IMPORTANT DISCLAIMER', 20, yPos + 8);
            
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            const disclaimerText = 'This AI-generated analysis is for informational purposes only and should not replace professional medical advice. Please consult with a qualified healthcare provider for proper diagnosis and treatment. The AI predictions are based on image analysis and may not be 100% accurate.';
            const disclaimerLines = doc.splitTextToSize(disclaimerText, 170);
            doc.text(disclaimerLines, 20, yPos + 15);
            
            // Footer
            doc.setFillColor(231, 76, 60);
            doc.rect(0, 280, 210, 17, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.text('MedDash Medical Center | Advanced AI Diagnostics | www.meddash.com', 105, 290, { align: 'center' });
            
            // Save the PDF
            doc.save(`CT_Scan_Report_${analysis.fullName.replace(/\s+/g, '_')}_${analysis.id}.pdf`);
            
            alert('‚úÖ Professional medical report downloaded successfully!');
        }

        // Initialize system when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
            initializeCTScanForm();
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                document.getElementById('sidebar').classList.remove('active');
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'977d5503f549c1a6',t:'MTc1NjY1MTc0MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
